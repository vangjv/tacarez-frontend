<div class="mt-5">
    <div class="col-12 md:col-6 lg:col-9 mx-auto">
        <div>
            <h1>My Merge Requests</h1>
            <p-table [value]="mergeRequests">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Feature Name</th>
                        <th>Revison Name</th>
                        <th class="text-center">Notes from requestor</th>
                        <th>Status</th>
                        <th style="width: 15%;">Created date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-merge>
                    <tr>
                        <td>{{merge.featureName}}</td>
                        <td>{{merge.revisionName}}</td>
                        <td class="text-center">
                            <span class="pr-2 pl-2">
                                <button pButton pRipple type="button" icon="far fa-comment" 
                                class="p-button-rounded p-button-outlined p-button-raised" pTooltip="View notes" tooltipPosition="top" (click)="openNotes(merge)"></button>
                            </span>
                        </td>
                        <td>{{merge.status ?? "Review not started"}}</td>
                        <td>{{merge.createdDate | date :'short' }}</td>
                        <td class="text-center">
                            <span class="pr-2 pl-2">
                                <button pButton pRipple type="button" icon="fas fa-search" 
                                class="p-button-rounded p-button-outlined p-button-raised" pTooltip="Open/View" tooltipPosition="top" (click)="reviewMergeMap(merge.featureName, merge.id)"></button>
                            </span>
                            <span class="pr-2 pl-2">
                                <button pButton pRipple type="button" icon="fas fa-user-plus" 
                                class="p-button-rounded p-button-outlined p-button-raised" pTooltip="Contributors" tooltipPosition="top"></button>
                            </span>
                            <span class="pr-2 pl-2">
                                <button pButton pRipple type="button" icon="far fa-envelope" 
                                class="p-button-rounded p-button-outlined p-button-raised" pTooltip="Request review" tooltipPosition="top" (click)="openStakeHolderReviewDialog(merge)"></button>
                            </span>
                            <span class="pr-2 pl-2">
                                <button pButton pRipple type="button" icon="far fa-thumbs-up" 
                                    class="p-button-rounded p-button-outlined p-button-raised" pTooltip="Approve merge" tooltipPosition="top"></button>
                            </span>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            <div class="mt-2" *ngIf="mergeRequests?.length == 0">
                You have no merge requests.
            </div>
        </div>
    </div>
</div>

<!-- Merge request modal -->
<p-dialog header="Request a merge" [(visible)]="showMergeRequestDialog" [style]="{width: '50vw'}">
    <div class="grid">
        <div class="col-12 md-4">
            <div class="mb-3">
                Requesting a merge will create a copy of your revision and submit it to the feature owner for review.                    
            </div>
            <div class="mb-3">
                By selected the merge option below and clicking Ok, you are requesting that the owner of the following feature review your revision: 
            </div>
            <div class="mb-3">
                <strong class="ml-5">{{selectedRevision?.featureName}}</strong>
            </div>
            <div class="mb-3">
                Once they review your review, it is up to them to approve and merge your changes into the feature or deny the merge request.
            </div>
            <div class="p-fluid">
                <div class="p-field mb-3">
                    <p-dropdown [options]="mergeOptions" [(ngModel)]="mergeSelection" optionLabel="name" optionValue="value" placeholder="Select an option"></p-dropdown>
                </div>
            </div>
            <div class="p-fluid" *ngIf="mergeSelection == 'Request merge'">
                <div class="p-field mb-3">
                    <textarea pInputTextarea [(ngModel)]="mergeNotes" class="w-100"></textarea>
                </div>
            </div>
        </div>
    </div>
    <p-footer>
        <button pButton (click)="createMergeRequest()" [disabled]="mergeSelection != 'Request merge' || requestingMerge == true">Ok</button>
    </p-footer>
</p-dialog>

<!-- Merge Notes Modal -->
<p-dialog header="Notes from merge requestor" [(visible)]="showMergeNotesDialog" [style]="{width: '50vw'}">
    <div class="grid">
        <div class="col-12">
            <div class="p-fluid">
                <div class="p-field mb-3">
                    <textarea pInputTextarea [(ngModel)]="selectedMergeRequestNotes" class="w-full" style="resize: none;" [rows]="5"></textarea>
                </div>
            </div>
        </div>
    </div>
    <p-footer>
        <button pButton (click)="showMergeNotesDialog = false">Close</button>
    </p-footer>
</p-dialog>


<!-------Request stakeholder review Modal( showStakeholder() )------->
<p-dialog [(visible)]="showStakeholderReviewDialog"[closeOnEscape]="true" [transitionOptions]="'100ms'" [resizable]="false" [modal]="true"
[style]="{width: '50vw'}" [baseZIndex]="10000" [maximizable]="true" header="Stakeholder Review Request" scrollHeight="flex">
    <p-table [value]="selectedMergeRequest?.stakeholderReview?.stakeholders" [scrollable]="true" scrollHeight="flex">
        <ng-template pTemplate="header">
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>                 
                <th>Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-merge>
            <tr>
                <td>{{merge.firstName + " " + merge.lastName}}</td>
                <td>{{merge.email}}</td>
                <td>
                    <p-dropdown [options]="envelopeRoles" optionLabel="label" [style]="{width: '100%'}"></p-dropdown>
                </td>
                <td>
                    <span class="text-right ml-5">
                        <button pButton pRipple type="button" icon="pi pi-trash"
                            class="p-button-rounded p-button-outlined p-button-raised p-button-danger">
                        </button>
                    </span>

                </td>
            </tr>
        </ng-template>
    </p-table>
    <form [formGroup]="stakeholderForm">
        <div class="row flex">
            <div class="col pr-3">
                <div class="p-inputgroup mt-1">
                    <input type="text" id="firstName" pInputText formControlName="firstName" placeholder="First Name" [style]="{width:'100%'}">         
                </div>
            </div>
            <div class="col pr-3">
                <div class="p-inputgroup mt-1">
                    <input type="text" id="lastName" pInputText formControlName="lastName" placeholder="Last Name" [style]="{width:'100%'}">         
                </div>
            </div>
            <div class="col pl-3">
                <div class="p-inputgroup mt-1">                 
                    <input type="text" id="email" pInputText formControlName="email" placeholder="Email" [style]="{width:'100%'}">       
                </div>
            </div>

            <div class="col-2 text-right pl-3 mt-1">
                <button pButton type="button"(click)="addStakeholder()" [disabled]="stakeholderForm.invalid" label="Add" [style]="{width:'100%'}"></button> 
            </div>
        </div>
        <div class="mt-3 pt-3">
            <button pButton type="button" (click)="display=false" label="Close" [style]="{width:'40%'}"></button>
        </div>
    </form>
    <ng-template pTemplate="footer">
        <div class="col-12">
            <label for="message" class="pb-2" style="font-weight: bold; text-align: left;">
                Message to reviewers:
            </label>
            <textarea pInputTextarea rows="8" autoResize="autoResize" class="w-full"></textarea>
        </div>
        <div class="col-12">
            <button pButton type="button" label="Send Request"></button>
        </div>
    </ng-template>
</p-dialog>